#!/usr/bin/env bash

OUTPUT_FILE="$HOME/dotfiles/packages/.config/packages/packages-list.txt"

function _backup_packages() {
    # Ensure the directory exists
    mkdir -p "$(dirname "$OUTPUT_FILE")"

    EXCLUDED_FILE="$HOME/dotfiles/packages/.config/packages/excluded_packages.txt"

    # Get the list of installed packages
    if [[ -f "$EXCLUDED_FILE" ]]; then
        # Remove packages listed in EXCLUDED_FILE
        pacman -Qqe | grep -Fxv -f "$EXCLUDED_FILE" | sort > "$OUTPUT_FILE"
    else
        # If no exclude file exists, save all packages
        pacman -Qqe | sort > "$OUTPUT_FILE"
    fi

    echo "Package list saved to $OUTPUT_FILE (excluding packages from $EXCLUDED_FILE)"
}

function _install_packages() {
    yay -S --noconfirm --needed - < $OUTPUT_FILE
}

function main() {
    _backup_packages

    if [[ "$1" == "--install" ]]; then
        _install_packages
    fi
}

main "$@"
